# 错误 740 修复说明

## 问题描述
程序启动时总是要求管理员权限，导致无法正常打开。

## 根本原因
1. 程序没有明确的 UAC manifest 配置
2. 启动逻辑中过度依赖提权操作
3. 没有给用户提供不使用管理员权限运行的选项

## 解决方案

### 1. 添加 UAC Manifest 文件
创建了 `Project1.exe.manifest`，明确指定：
- 执行级别：`asInvoker`（以调用者权限运行，不自动要求管理员）
- 支持 Windows 7 到 Windows 11
- 启用 DPI 感知

### 2. 修改项目配置（Project1.vcxproj）
在所有配置（Debug/Release, Win32/x64）中添加：
```xml
<Link>
  <UACExecutionLevel>AsInvoker</UACExecutionLevel>
</Link>
<Manifest>
  <AdditionalManifestFiles>Project1.exe.manifest</AdditionalManifestFiles>
</Manifest>
```

### 3. 简化启动逻辑（Project1.cpp）

#### 移除自动提权
- 移除 `RelaunchSelfElevatedIfNeeded()` 中的自动提权逻辑
- 程序启动时不再强制请求管理员权限

#### 简化错误处理
- 移除复杂的 ShellExecuteEx + runas 重试逻辑
- 当遇到错误 740 时，直接提示用户以管理员身份运行本程序

## 使用说明

### 正常使用（推荐）
1. 直接双击运行程序（无需管理员权限）
2. 输入验证码进入主界面
3. 选择目标 EXE 文件
4. 点击启动

### 当目标程序需要管理员权限时
如果目标程序本身需要管理员权限，会看到提示：
```
目标程序需要管理员权限才能启动。
请右键点击本程序并选择"以管理员身份运行"后重试。
```

此时：
1. 关闭当前程序
2. 右键点击程序图标
3. 选择"以管理员身份运行"
4. 重新执行启动操作

## 优势

### 修改前
- ❌ 每次启动都要UAC提权
- ❌ 用户取消UAC后程序行为异常
- ❌ 无法在标准用户权限下使用
- ❌ 错误提示不清晰

### 修改后
- ✅ 默认以普通权限运行
- ✅ 只在需要时提示以管理员身份运行
- ✅ 可在标准用户权限下正常使用
- ✅ 清晰的错误提示和解决方案
- ✅ 用户可以自主选择是否需要管理员权限

## 技术细节

### UAC 执行级别
- `asInvoker`: 以调用者权限运行（当前用户权限）
- `highestAvailable`: 以可用的最高权限运行
- `requireAdministrator`: 必须以管理员身份运行（会导致每次都弹UAC）

### Manifest 的作用
Manifest 文件嵌入到 EXE 中，Windows 会在启动程序前读取并根据配置决定：
- 是否需要 UAC 提权
- 程序的兼容性设置
- DPI 感知等显示设置

## 编译要求
- Visual Studio 2015 或更高版本
- Windows SDK 10.0
- 支持平台：Win32, x64
- 配置：Debug, Release

## 文件清单
- ✅ `Project1.exe.manifest` - UAC 配置文件（新增）
- ✅ `Project1.vcxproj` - 项目文件（已修改）
- ✅ `Project1.cpp` - 主程序代码（已优化）
- ✅ `.gitignore` - Git 忽略文件（新增）

## 测试建议
1. **普通启动测试**：直接运行，验证无UAC提示
2. **功能测试**：测试 AI 功能、托盘功能等基础功能
3. **目标程序测试**：尝试启动需要/不需要管理员权限的目标程序
4. **错误处理测试**：测试各种错误场景的提示信息

## 注意事项
- 程序本身不再要求管理员权限
- DLL 注入等操作仍然可能需要管理员权限（取决于目标程序）
- 建议用户在需要时主动以管理员身份运行
- 保持了所有原有功能（AI助手、自动查找、托盘隐藏等）
