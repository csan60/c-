<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cl.dao.HealthDao">

    <!-- 结果映射 -->
    <resultMap id="healthRecordMap" type="com.cl.entity.HealthRecord">
        <id property="id" column="id"/>
        <result property="huanzheId" column="huanzhe_id"/>
        <result property="recordDate" column="record_date"/>
        <result property="heightCm" column="height_cm"/>
        <result property="weightKg" column="weight_kg"/>
        <result property="bmi" column="bmi"/>
        <result property="temperature" column="temperature"/>
        <result property="systolic" column="systolic"/>
        <result property="diastolic" column="diastolic"/>
        <result property="heartRate" column="heart_rate"/>
        <result property="bloodOxygen" column="blood_oxygen"/>
        <result property="bloodSugar" column="blood_sugar"/>
        <result property="bodyFat" column="body_fat"/>
        <result property="bloodLipids" column="blood_lipids"/>
        <result property="stepsToday" column="steps_today"/>
        <result property="caloriesBurned" column="calories_burned"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 根据患者ID获取最新的健康记录 -->
    <select id="getLatestByHuanzheId" resultMap="healthRecordMap">
        SELECT * FROM health_record 
        WHERE huanzhe_id = #{huanzheId} 
        ORDER BY record_date DESC 
        LIMIT 1
    </select>

    <!-- 根据患者ID和时间范围查询健康记录 -->
    <select id="getByHuanzheIdAndDateRange" resultMap="healthRecordMap">
        SELECT * FROM health_record 
        WHERE huanzhe_id = #{huanzheId}
        <if test="startDate != null">
            AND DATE(record_date) &gt;= DATE(#{startDate})
        </if>
        <if test="endDate != null">
            AND DATE(record_date) &lt;= DATE(#{endDate})
        </if>
        ORDER BY record_date DESC
    </select>

    <!-- 获取患者今日步数统计 -->
    <select id="getTodaySteps" resultType="java.lang.Integer">
        SELECT steps_today FROM health_record 
        WHERE huanzhe_id = #{huanzheId} 
        AND DATE(record_date) = CURDATE()
        ORDER BY record_date DESC 
        LIMIT 1
    </select>

    <!-- 获取患者本周平均心率 -->
    <select id="getWeeklyAvgHeartRate" resultType="java.lang.Double">
        SELECT AVG(heart_rate) FROM health_record 
        WHERE huanzhe_id = #{huanzheId}
        AND record_date &gt;= DATE_SUB(NOW(), INTERVAL 7 DAY)
        AND heart_rate IS NOT NULL
    </select>

</mapper>