# 日志系统功能说明

## 更新内容
已为程序添加完整的日志系统，所有操作和错误都会自动记录到日志文件中，方便排查问题。

## 日志文件位置
日志文件保存在程序所在目录，命名格式：
```
Injector_Log_YYYYMMDD_HHMMSS.txt
```

例如：`Injector_Log_20241117_153045.txt`

## 日志包含的信息

### 启动信息
- 程序启动时间
- 命令行参数
- COM和GDI+初始化状态
- 窗口类注册信息
- 主窗口创建过程

### 操作日志
- 用户点击按钮
- 目标程序路径
- DLL下载和注入过程
- 进程启动结果
- 错误代码和详细描述

### 日志级别
- `INFO`：正常操作信息
- `WARN`：警告信息
- `ERROR`：错误信息
- `DEBUG`：调试信息

## 日志格式示例
```
=== Injector 日志文件 ===
启动时间: 2024-11-17 15:30:45
日志路径: C:\Users\Username\Desktop\Injector_Log_20241117_153045.txt

[15:30:45.123] [INFO] 程序启动，命令行: "C:\Users\Username\Desktop\Project1.exe"
[15:30:45.234] [INFO] COM初始化成功
[15:30:45.345] [INFO] GDI+初始化成功
[15:30:45.456] [INFO] 窗口类注册成功，Atom: 0xC045
[15:30:45.567] [INFO] InitInstance: hInstance=0x00400000, nCmdShow=10
[15:30:45.678] [INFO] 窗口计算尺寸: 648 x 239
[15:30:45.789] [INFO] 主窗口句柄: 0x000A0512
[15:30:45.890] [INFO] WM_CREATE 开始，hWnd=0x000A0512
[15:30:45.999] [INFO] 第一阶段控件已创建
[15:30:46.123] [INFO] 用户点击启动按钮
[15:30:46.234] [INFO] 目标EXE: C:\Program Files\CXExam\CXExam.exe
[15:30:46.345] [INFO] 工作目录: C:\Program Files\CXExam
[15:30:46.456] [INFO] DLL 目标路径: C:\Program Files\CXExam\winmm.dll
[15:30:47.567] [INFO] CreateProcessW 成功，PID=12345
```

## 如何使用日志排查问题

### 1. 程序无法启动
查看日志文件的开头部分，检查：
- COM初始化是否成功
- GDI+初始化是否成功
- 窗口类注册是否成功
- CreateWindowW 是否失败

### 2. 目标程序无法启动
搜索关键词：
- `用户点击启动按钮`
- `CreateProcessW`
- `ERROR`

查看错误代码：
- 错误 740：需要管理员权限
- 其他错误代码可以参考 Windows 系统错误码

### 3. DLL注入失败
搜索关键词：
- `Inject`
- `LoadLibrary`
- `Remote load`

## 错误提示框改进
现在当出现错误时，错误提示框中会显示日志文件的完整路径，例如：
```
启动失败，错误代码：740

操作需要提升。

请查看日志文件：
C:\Users\Username\Desktop\Injector_Log_20241117_153045.txt
```

直接打开该路径的文件即可查看详细日志。

## 注意事项
1. 日志文件使用 UTF-16 编码（支持中文），可以用记事本直接打开
2. 每次启动程序都会创建新的日志文件
3. 日志文件较多时可以定期清理
4. 如果程序所在目录没有写入权限，日志创建可能失败，此时需要以管理员身份运行
5. 日志文件已添加到 .gitignore，不会被提交到版本控制

## 技术细节
- 使用临界区（CRITICAL_SECTION）保证多线程日志写入的安全性
- 日志同时输出到文件和控制台（如果有）
- BOM 标记（\xFEFF）确保文件以 UTF-16 格式正确识别
- 毫秒级时间戳方便精确定位问题发生的时刻
